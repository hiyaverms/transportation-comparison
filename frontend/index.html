<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Draggable Route + Input Addresses</title>
  <style>
    #map { height: 100vh; width: 100%; }
    #info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 5;
      font-family: sans-serif;
    }
    #info-panel input {
      width: 200px;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info-panel">
    <div>
      <label>Start: </label>
      <input id="start-input" placeholder="Enter start location" />
    </div>
    <div>
      <label>End: </label>
      <input id="end-input" placeholder="Enter end location" />
    </div>
    <p><strong>Current Start:</strong> <span id="start-location"></span></p>
    <p><strong>Current End:</strong> <span id="end-location"></span></p>
  </div>
  <script>
    fetch("http://localhost:8080/api/key")
    .then(res => res.json())
    .then(data => {
        const GOOGLE_API_KEY = data.key;
        console.log("My API key:", GOOGLE_API_KEY);
    });
  </script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjiyHC6BbbmYQNFT69FV6IhVRAQw-Gcz8&callback=initMap"
    async
    defer
  ></script>

  <script>
    let map, directionsService, directionsRenderer, geocoder;
    let startMarker, endMarker;

    function initMap() {
      const boston = { lat: 42.3601, lng: -71.0589 };
      const cambridge = { lat: 42.3736, lng: -71.1097 };

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: boston
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true });
      geocoder = new google.maps.Geocoder();

      // Create draggable markers
      startMarker = new google.maps.Marker({ position: boston, map, draggable: true });
      endMarker = new google.maps.Marker({ position: cambridge, map, draggable: true });

      // Update route and locations when dragged
      startMarker.addListener("dragend", () => { calculateRoute(); updateLocation(startMarker, "start-location"); });
      endMarker.addListener("dragend", () => { calculateRoute(); updateLocation(endMarker, "end-location"); });

      // Initial route and locations
      calculateRoute();
      updateLocation(startMarker, "start-location");
      updateLocation(endMarker, "end-location");

      // Input boxes
      const startInput = document.getElementById("start-input");
      const endInput = document.getElementById("end-input");

      startInput.addEventListener("change", () => { geocodeAddress(startInput.value, startMarker, "start-location"); });
      endInput.addEventListener("change", () => { geocodeAddress(endInput.value, endMarker, "end-location"); });
    }

    function calculateRoute() {
      directionsService.route({
        origin: startMarker.getPosition(),
        destination: endMarker.getPosition(),
        travelMode: google.maps.TravelMode.DRIVING
      }, (result, status) => {
        if (status === "OK") directionsRenderer.setDirections(result);
        else console.error("Directions request failed:", status);
      });
    }

    function updateLocation(marker, elementId) {
        geocoder.geocode({ location: marker.getPosition()},
            (results, status) => {
            let display;
            if (status === "OK" && results[0]) {
                display = results[0].formatted_address;
            } else {
                display = marker.getPosition().toUrlValue(6); // fallback to "lat,lng"
            }
            document.getElementById(elementId).textContent = display;
            }
        );
    }


    function geocodeAddress(address, marker, elementId) {
      geocoder.geocode({ address: address }, (results, status) => {
        if (status === "OK" && results[0]) {
          const location = results[0].geometry.location;
          marker.setPosition(location);
          map.panTo(location);
          updateLocation(marker, elementId);
          calculateRoute();
        } else {
          alert("Address not found: " + status);
        }
      });
    }
  </script>
</body>
</html>
